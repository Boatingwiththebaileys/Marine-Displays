[env:waveshare_28_round]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; Serial monitor and upload settings
monitor_speed = 115200
upload_speed = 115200

; Build flags for Waveshare ESP32-S3-Touch-LCD with CH343 USB chip
build_flags = 
    -DCORE_DEBUG_LEVEL=0
    -DLOG_LOCAL_LEVEL=0
    -DLV_CONF_INCLUDE_SIMPLE
    -DLV_USE_DRAW_SW_ASM=0
    -DLV_USE_NATIVE_HELIUM_ASM=0
    -DLV_USE_ARM2D=0
    ; CRITICAL: Board has CH343 USB chip, needs USB CDC or HWCDC for serial output
    -DARDUINO_USB_CDC_ON_BOOT=1
    -I include
    -I src
    ; Set data cache line size to 64 bytes for reduced RGB display lag/flicker
    -DCONFIG_ESP32S3_DATA_CACHE_LINE_64B=1
    ; Set PSRAM to maximum speed (120MHz OPI) for better bandwidth
    -DCONFIG_SPIRAM_SPEED_120M=1
    ; CRITICAL: Restart DMA transmission in VSYNC to prevent permanent desync
    -DCONFIG_LCD_RGB_RESTART_IN_VSYNC=1
    ; Disable WiFi NVS to prevent flash writes blocking PSRAM/display access
    -DCONFIG_ESP_WIFI_NVS_ENABLED=0
    ; Enable PSRAM for malloc/heap allocation
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue

; Memory Configuration - CRITICAL: Board has 8MB OPI PSRAM, must enable it
board_build.arduino.memory_type = qio_opi
board_build.flash_mode = dio  
board_build.psram_type = opi
board_upload.flash_size = 16MB
#board_build.partitions = partitions.csv
; Use custom partitions that explicitly fit a 16MB flash
board_build.partitions = partitions.csv
board_build.filesystem = spiffs

lib_deps =
    lvgl/lvgl@^8.3.0
    bblanchon/ArduinoJson
    Links2004/WebSockets
